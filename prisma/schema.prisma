generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id              Int        @id @default(autoincrement())
  name            String?    @db.VarChar(200)
  legal_name      String?    @db.VarChar(300)
  phone           String?    @db.VarChar(50)
  email           String?    @db.VarChar(150)
  specialization  String?    @db.VarChar(20)
  logo_url        String?
  requisites_json Json?
  disk_quota_mb   Int?
  disk_used_mb    Int?
  status          String?    @db.VarChar(20)
  created_at      DateTime?  @db.Timestamptz(6)
  parts           Part[]
  employees       Employee[]
  roles           Role[]
  counterparties  Counterparty[]
  deals           Deal[]
  money_categories MoneyCategory[]
  money_movements  MoneyMovement[]

  @@map("РєРѕРјРїР°РЅРёРё")
}

model Employee {
  id                  Int       @id @default(autoincrement())
  company_id          Int?
  full_name           String?   @db.VarChar(200)
  phone               String?   @db.VarChar(50)
  email               String?   @db.VarChar(150)
  position            String?   @db.VarChar(100)
  pin_code_hash       String?   @db.VarChar(255)
  is_active           Boolean?
  created_at          DateTime? @db.Timestamptz(6)
  last_login_at       DateTime? @db.Timestamptz(6)
  pin_updated_at      DateTime? @db.Timestamptz(6)
  pin_failed_attempts Int       @default(0)
  pin_locked_until    DateTime? @db.Timestamptz(6)
  
  company             Company?  @relation(fields: [company_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  roles               RoleEmployee[]
  deals               Deal[]
  money_movements     MoneyMovement[]

  @@map("СЃРѕС‚СЂСѓРґРЅРёРєРё")
}

model Role {
  id                Int              @id @default(autoincrement())
  company_id        Int?
  name              String?          @db.VarChar(100)
  is_system_default Boolean?

  company           Company?         @relation(fields: [company_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  permissions       RolePermission[]
  employees         RoleEmployee[]

  @@map("РЎР‚Р С•Р В»Р С‘")
}

model RolePermission {
  id               Int     @id @default(autoincrement())
  role_id          Int?
  permission_code  String? @db.VarChar(100)

  role             Role?   @relation(fields: [role_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@map("Р С—РЎР‚Р В°Р Р†Р В°_РЎР‚Р С•Р В»Р ВµР в„–")
}

model RoleEmployee {
  employee_id Int
  role_id     Int

  employee    Employee @relation(fields: [employee_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "role_employee_employee_id_fkey")
  role        Role     @relation(fields: [role_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "role_employee_role_id_fkey")

  @@id([employee_id, role_id])
  @@map("РЎР‚Р С•Р В»Р С‘_РЎРѓР С•РЎвЂљРЎР‚РЎС“Р Т‘Р Р…Р С‘Р С”Р С•Р Р†")
}

model AutoDonor {
  id             Int       @id @default(autoincrement())
  company_id     Int?
  vin            String?   @db.VarChar(50)
  make           String?   @db.VarChar(100)
  model          String?   @db.VarChar(100)
  year           Int?
  body_type      String?   @db.VarChar(100)
  engine         String?   @db.VarChar(100)
  transmission   String?   @db.VarChar(100)
  purchase_price Decimal?  @db.Decimal(12, 2)
  status         String?   @db.VarChar(30)
  created_at     DateTime? @db.Timestamptz(6)
  parts          Part[]

  @@map("Р°РІС‚Рѕ_РґРѕРЅРѕСЂС‹")
}

model Part {
  id              Int        @id @default(autoincrement())
  company_id      Int?
  auto_donor_id   Int?
  name            String?    @db.VarChar(200)
  oem_number      String?    @db.VarChar(100)
  internal_sku    String?    @db.VarChar(100)
  condition       String?    @db.VarChar(20)
  current_price   Decimal?   @db.Decimal(12, 2)
  temp_price      Decimal?   @db.Decimal(12, 2)
  allocated_cost  Decimal?   @db.Decimal(12, 2)
  status          String?    @db.VarChar(30)
  liquidity_color String?    @db.VarChar(10)
  storage_days    Int?
  created_at      DateTime?  @db.Timestamptz(6)
  autoDonor       AutoDonor? @relation(fields: [auto_donor_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  company         Company?   @relation(fields: [company_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  deal_items      DealItem[]

  @@map("Р·Р°РїС‡Р°СЃС‚Рё")
}

model Counterparty {
  id                    Int       @id @default(autoincrement())
  company_id            Int?
  name                  String?   @db.VarChar(200)
  phone                 String?   @db.VarChar(50)
  email                 String?   @db.VarChar(150)
  type                  String?   @db.VarChar(30)
  delivery_preferences  String?   @db.Text
  comment               String?   @db.Text
  created_at            DateTime? @db.Timestamptz(6)

  company               Company?  @relation(fields: [company_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "counterparty_company_id_fkey")
  deals                 Deal[]

  @@map("контрагенты")
}

model Deal {
  id                        Int        @id @default(autoincrement())
  company_id                Int?
  counterparty_id           Int?
  responsible_employee_id   Int?
  stage                     String?    @db.VarChar(30)
  total_amount              Decimal?   @db.Decimal(12, 2)
  total_cost                Decimal?   @db.Decimal(12, 2)
  profit                    Decimal?   @db.Decimal(12, 2)
  source                    String?    @db.VarChar(50)
  created_at                DateTime?  @db.Timestamptz(6)
  closed_at                 DateTime?  @db.Timestamptz(6)

  company                   Company?   @relation(fields: [company_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "deal_company_id_fkey")
  counterparty              Counterparty? @relation(fields: [counterparty_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "deal_counterparty_id_fkey")
  responsible               Employee?  @relation(fields: [responsible_employee_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "deal_responsible_employee_id_fkey")
  items                     DealItem[]
  money_movements           MoneyMovement[]

  @@map("сделки")
}

model DealItem {
  id                 Int       @id @default(autoincrement())
  deal_id            Int?
  part_id            Int?
  quantity           Int?
  price              Decimal?  @db.Decimal(12, 2)
  cost               Decimal?  @db.Decimal(12, 2)
  reserved_from      DateTime? @db.Timestamptz(6)
  reserved_until     DateTime? @db.Timestamptz(6)
  reservation_status String?   @db.VarChar(20)

  deal               Deal?     @relation(fields: [deal_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "deal_item_deal_id_fkey")
  part               Part?     @relation(fields: [part_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "deal_item_part_id_fkey")

  @@map("позиции_сделки")
}

model MoneyCategory {
  id          Int     @id @default(autoincrement())
  company_id  Int?
  name        String? @db.VarChar(150)
  type        String? @db.VarChar(20)

  company     Company? @relation(fields: [company_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "money_category_company_id_fkey")
  movements   MoneyMovement[]

  @@map("категории_движения_денег")
}

model MoneyMovement {
  id                     Int       @id @default(autoincrement())
  company_id             Int?
  type                   String?   @db.VarChar(20)
  category_id            Int?
  amount                 Decimal?  @db.Decimal(12, 2)
  operation_date         DateTime? @db.Date
  related_deal_id        Int?
  comment                String?   @db.Text
  created_by_employee_id Int?
  created_at             DateTime? @db.Timestamptz(6)

  company                Company?  @relation(fields: [company_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "money_movement_company_id_fkey")
  category               MoneyCategory? @relation(fields: [category_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "money_movement_category_id_fkey")
  related_deal           Deal?     @relation(fields: [related_deal_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "money_movement_deal_id_fkey")
  created_by             Employee? @relation(fields: [created_by_employee_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "money_movement_created_by_fkey")

  @@map("движения_денег")
}
